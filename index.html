<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X Academy | رحلة احتراف المعادلات البسيطة</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #099999;
            --primary-light: #e0f7f7;
            --accent: #f39c12;
            --dark: #2c3e50;
            --text-gray: #636e72;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; transition: all 0.3s ease; }
        
        body {
            background-color: #f0f4f8;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Default for Laptop */
            color: var(--dark);
        }

        /* --- Header --- */
        header {
            background: #fff;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 100;
            flex-shrink: 0;
        }

        .logo-text {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 900;
            font-size: 1.8rem;
        }

        .logo-x { color: var(--primary); }
        .logo-name { color: #000; }

        .app-title {
            font-weight: 800;
            color: #000;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- Layout --- */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden; /* Default for Laptop */
        }

        /* --- Sidebar --- */
        .side-panel {
            width: 260px;
            background: #fff;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            border-left: 1px solid #eee;
            flex-shrink: 0;
        }

        .lesson-btn {
            background: transparent;
            border: none;
            text-align: right;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-gray);
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            white-space: nowrap;
        }

        .lesson-btn:hover { background: #f8f9fa; color: var(--primary); transform: translateX(-3px); }
        
        .lesson-btn.active {
            background: var(--primary-light);
            color: var(--primary);
            font-weight: 800;
            border-right: 4px solid var(--primary);
        }

        /* --- Main Interaction Area --- */
        .interaction-panel {
            flex: 2;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background: radial-gradient(circle at top left, #fcfdfd, #ecf0f1);
            overflow-y: auto;
        }

        .progress-container {
            width: 90%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            flex-shrink: 0;
        }
        .progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            border-radius: 10px;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- Formula Stage --- */
        .formula-stage {
            background: #fff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 750px;
            text-align: center;
            border: 1px solid #fff;
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative; /* مهم لتموضع الشخصية */
        }

        /* --- Character Mascot Style --- */
        .mascot-img {
            position: absolute;
            top: -95px; /* يظهر من الأعلى */
            left: -40px; /* يظهر من الجانب الأيسر */
            width: 140px;
            height: auto;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.1));
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
        }

        .mascot-img:hover {
            transform: scale(1.1) rotate(-5deg);
        }

        .goal-box {
            background: #fff8e1;
            border: 1px solid #ffe082;
            color: #d35400;
            padding: 15px;
            border-radius: 10px;
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-align: right;
            margin-top: 10px; /* مسافة بسيطة عشان الشخصية ما تغطي الكلام */
        }
        
        .goal-icon { font-size: 1.5rem; color: #f39c12; flex-shrink: 0; }

        .step-label {
            font-size: 0.85rem;
            color: var(--text-gray);
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 1px;
            align-self: flex-start;
        }

        .visual-code-container {
            background: #2c3e50;
            border-radius: 12px;
            padding: 20px 30px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
            text-align: left;
            direction: ltr;
            min-height: 80px;
            display: flex;
            align-items: center;
        }

        .visual-code {
            font-family: 'Consolas', 'Monaco', monospace;
            color: #ecf0f1;
            font-size: 1.8rem;
            font-weight: bold;
            line-height: 1.4;
            word-break: break-all;
        }

        .cursor {
            display: inline-block;
            width: 10px;
            height: 28px;
            background: var(--accent);
            animation: blink 1s infinite;
            margin-left: 5px;
        }

        @keyframes blink { 50% { opacity: 0; } }

        .explanation-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: var(--dark);
            min-height: 60px;
        }

        .highlight-text { color: var(--primary); font-weight: 800; }

        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            width: 100%;
            margin-top: 10px;
        }

        .btn {
            padding: 12px 35px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }
        
        .btn:active { transform: scale(0.98); }

        .btn-next { 
            background: var(--primary); 
            color: #fff; 
            box-shadow: 0 4px 15px rgba(9, 153, 153, 0.3);
        }
        .btn-next:hover { background: #077a7a; box-shadow: 0 6px 20px rgba(9, 153, 153, 0.4); }

        .btn-back { background: #fff; border: 2px solid #ddd; color: var(--text-gray); }
        .btn-back:hover { border-color: var(--primary); color: var(--primary); }

        /* --- Data Panel (Table) --- */
        .data-panel {
            flex: 1.2;
            background: #fff;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 20px rgba(0,0,0,0.03);
            padding: 15px;
            overflow: hidden;
        }

        .table-container {
            overflow: auto;
            border-radius: 10px;
            border: 1px solid #eee;
            height: 100%;
        }

        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #f8f9fa; padding: 12px; position: sticky; top: 0; z-index: 2; text-align: center; color: var(--dark); white-space: nowrap; }
        td { padding: 10px; text-align: center; border-bottom: 1px solid #f1f1f1; transition: background 0.3s; white-space: nowrap; }
        
        /* Special Cells */
        .empty-cell { background: #ffeaa7; color: #d35400; font-style: italic; font-size: 0.8rem; }
        .text-cell { color: #c0392b; font-weight: bold; }

        /* Highlight Effects */
        .highlight-col { background-color: #d1f2eb !important; color: var(--primary-dark); font-weight: bold; transform: scale(1.02); }
        .highlight-criteria { background-color: #fad7a0 !important; color: #e67e22; font-weight: bold; }
        
        /* --- Footer --- */
        footer {
            background: var(--dark);
            color: #fff;
            padding: 15px 0;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            flex-shrink: 0;
        }

        footer a {
            color: #fff;
            text-decoration: none;
            font-size: 1.8rem;
            transition: color 0.3s;
        }

        footer a:hover { color: var(--accent); transform: scale(1.1); }
        footer span { font-size: 0.9rem; opacity: 0.7; margin-left: 10px; }

        /* =========================================
            MOBILE & TABLET RESPONSIVENESS
        ========================================= */
        @media (max-width: 1024px) {
            body {
                height: auto; /* Enable full scrolling on mobile */
                overflow-y: auto;
            }

            .main-container {
                flex-direction: column;
                height: auto;
                overflow: visible;
            }

            /* Header adjustments */
            header { padding: 0 15px; height: 60px; }
            .logo-text { font-size: 1.4rem; }
            .app-title { font-size: 1.1rem; }

            /* Sidebar becomes horizontal scroll menu */
            .side-panel {
                width: 100%;
                height: auto;
                flex-direction: row;
                overflow-x: auto;
                padding: 10px;
                border-left: none;
                border-bottom: 1px solid #eee;
                order: 1; /* Sidebar First */
                -webkit-overflow-scrolling: touch; /* Smooth scroll */
            }
            
            .side-panel::-webkit-scrollbar { height: 4px; }
            .side-panel::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

            .lesson-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
                border-radius: 20px;
                background: #f1f2f6;
                margin-left: 8px;
            }
            
            .lesson-btn.active {
                border-right: none;
                background: var(--primary);
                color: #fff;
            }

            /* Main Interaction Area */
            .interaction-panel {
                order: 2; /* Content Second */
                padding: 40px 15px 20px 15px; /* Top padding increased for mascot */
                min-height: auto;
                background: linear-gradient(to bottom, #fcfdfd, #ecf0f1);
            }

            .formula-stage {
                padding: 20px;
                width: 100%;
                margin-top: 30px; /* Space for mascot */
            }

            .mascot-img {
                width: 100px;
                top: -70px;
                left: 50%; /* Center on mobile */
                transform: translateX(-50%); /* Center trick */
            }
            
            .mascot-img:hover {
                 transform: translateX(-50%) scale(1.1);
            }

            .visual-code { font-size: 1.2rem; }
            .visual-code-container { padding: 15px; min-height: 60px; }
            
            .controls { flex-direction: column-reverse; gap: 10px; }
            .btn { width: 100%; justify-content: center; }

            /* Data Panel (Table) moves to bottom */
            .data-panel {
                order: 3; /* Table Last */
                height: 400px; /* Fixed height for scrolling */
                border-right: none;
                border-top: 1px solid #eee;
                flex: none;
                width: 100%;
            }

            /* Footer */
            footer { flex-direction: column; gap: 10px; padding: 20px 0; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo-text">
        <span class="logo-x">X</span>
        <span class="logo-name">اكاديمي</span>
    </div>

    <div class="app-title"><i class="fas fa-calculator"></i> <span style="display:none; display:inline-block;">المعادلات البسيطة</span></div>
</header>

    <div class="main-container">
        <nav class="side-panel" id="sidePanel"></nav>

        <main class="interaction-panel">
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <div class="formula-stage">
                <img src="" alt="المساعد الذكي" class="mascot-img" id="mascotChar">

                <div class="goal-box">
                    <i class="fas fa-bullseye goal-icon"></i>
                    <div id="goalText">جاري تحميل المطلوب...</div>
                </div>

                <div class="step-label" id="stepLabel">خطوة 1</div>
                
                <div class="visual-code-container">
                    <span class="visual-code" id="visualCode"></span><span class="cursor"></span>
                </div>
                
                <p class="explanation-text" id="explanationText"></p>
                
                <div class="controls">
                    <button class="btn btn-back" id="backBtn" onclick="goBack()">عودة</button>
                    <button class="btn btn-next" id="nextBtn" onclick="goNext()">التالي <i class="fas fa-arrow-left"></i></button>
                </div>
            </div>
        </main>

        <aside class="data-panel">
            <div style="padding-bottom: 10px; font-weight:bold; color:var(--dark); text-align:center; border-bottom:1px solid #eee; margin-bottom:10px;">
                <i class="fas fa-table"></i> درجات الطلاب (معاينة حية)
            </div>
            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الاسم</th>
                            <th id="col-class">الشعبة</th> <th id="col-score">الدرجة</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </aside>
    </div>

    <footer>
        <span>Developed by Basel Ghanem</span>
        
        <div>
            <a href="https://www.linkedin.com/in/baselghanem/" target="_blank" title="LinkedIn">
                <i class="fab fa-linkedin"></i>
            </a>

            <a href="https://wa.me/962788458787" target="_blank" title="WhatsApp" style="margin-right: 15px;">
                <i class="fab fa-whatsapp"></i>
            </a>
        </div>
    </footer>

    <script>
        /*
            الهيكل الجديد:
            - goal: النص الذي سيظهر دائماً في الأعلى (السؤال).
            - steps: خطوات كتابة الكود فقط.
        */

        const lessons = [
            { 
                name: "SUM", 
                goal: "المطلوب: حساب <b>المجموع الكلي</b> لدرجات جميع الطلاب في الكشف.",
                steps: [
                    { t: "البداية", code: "=SUM(", d: "نكتب اسم الدالة SUM لجمع الأرقام.", h: [] },
                    { t: "التحديد", code: "=SUM(D2:D9", d: "نحدد عمود الدرجات بالكامل.", h: [3] },
                    { t: "الإغلاق", code: "=SUM(D2:D9)", d: "نغلق القوس.", h: [3] },
                    { t: "النتيجة", code: "594", d: "مجموع كل الدرجات الموجودة.", h: [] }
                ]
            },
            { 
                name: "MIN", 
                goal: "المطلوب: معرفة <b>أقل درجة</b> حصل عليها أي طالب في الكشف.",
                steps: [
                    { t: "البداية", code: "=MIN(", d: "دالة MIN تستخرج أصغر قيمة (Minimum).", h: [] },
                    { t: "التحديد", code: "=MIN(D2:D9", d: "نحدد نطاق الدرجات للبحث فيه.", h: [3] },
                    { t: "النتيجة", code: "=MIN(D2:D9) -> 65", d: "أقل درجة في الكشف هي 65.", h: [3] }
                ]
            },
            { 
                name: "MAX", 
                goal: "المطلوب: معرفة <b>أعلى درجة</b> في الكشف كاملاً.",
                steps: [ 
                    { t: "البداية", code: "=MAX(", d: "دالة MAX تستخرج أكبر قيمة.", h: [] },
                    { t: "التحديد", code: "=MAX(D2:D9", d: "نحدد عمود الدرجات.", h: [3] },
                    { t: "النتيجة", code: "98", d: "أعلى درجة هي 98 (لاحظ تجاهل النصوص).", h: [3] }
                ]
            },
            { 
                name: "COUNT", 
                goal: "المطلوب: معرفة عدد الطلاب الذين لديهم <b>درجة رقمية مرصودة</b> فقط.",
                steps: [
                    { t: "المفهوم", code: "=COUNT(", d: "انتبه: COUNT تعد <span class='highlight-text'>الأرقام فقط</span>.", h: [] },
                    { t: "التحديد", code: "=COUNT(D2:D9", d: "سنحدد النطاق الذي يحتوي على (أرقام، فراغ، نص).", h: [3] },
                    { t: "التحليل", code: "=COUNT(D2:D9)", d: "سيتم تجاهل الخلية الفارغة وكلمة 'غائب'.", h: [3] },
                    { t: "النتيجة", code: "6", d: "لدينا 6 خلايا تحتوي على أرقام فقط.", h: [] }
                ]
            },
            { 
                name: "AVERAGE", 
                goal: "المطلوب: حساب <b>متوسط الدرجات (المعدل)</b> للطلاب الحاضرين.",
                steps: [
                    { t: "البداية", code: "=AVERAGE(", d: "حساب المعدل (المتوسط الحسابي).", h: [] },
                    { t: "التحديد", code: "=AVERAGE(D2:D9", d: "نحدد الدرجات.", h: [3] },
                    { t: "الآلية", code: "=AVERAGE(D2:D9)", d: "المجموع ÷ العدد (يتجاهل الفارغ والنص تلقائياً).", h: [3] },
                    { t: "النتيجة", code: "99", d: "معدل درجات الطلاب الحاضرين.", h: [] }
                ]
            },
            { 
                name: "COUNTA", 
                goal: "المطلوب: معرفة العدد الكلي للطلاب <b>غير الفارغين</b> (حضور + غياب).",
                steps: [
                    { t: "المفهوم", code: "=COUNTA(", d: "COUNTA تعد <span class='highlight-text'>الكل</span> (All) ما عدا الفراغ.", h: [] },
                    { t: "التحديد", code: "=COUNTA(D2:D9", d: "نحدد نفس النطاق السابق.", h: [3] },
                    { t: "الفرق", code: "=COUNTA(D2:D9)", d: "سيتم عد كلمة 'غائب' لأنها ليست فارغة!", h: [3] },
                    { t: "النتيجة", code: "7", d: "العدد 7 (6 أرقام + 1 نص). الفراغ فقط لم يحسب.", h: [] }
                ]
            },
            { 
                name: "LARGE", 
                goal: "المطلوب: معرفة <b>ثاني أعلى درجة</b> في الفصل (الترتيب رقم 2).",
                steps: [
                    { t: "المفهوم", code: "=LARGE(", d: "تستخدم لجلب الترتيب (الأول، الثاني، الثالث...).", h: [] },
                    { t: "النطاق", code: "=LARGE(D2:D9,", d: "أولاً نحدد نطاق الدرجات.", h: [3] },
                    { t: "الرتبة K", code: "=LARGE(D2:D9, 2)", d: "الرقم 2 يعني: اعطني <span class='highlight-text'>ثاني</span> أعلى قيمة.", h: [3] },
                    { t: "النتيجة", code: "95", d: "ثاني أعلى درجة بعد الـ 98 هي 95.", h: [] }
                ]
            },
            { 
                name: "SMALL", 
                goal: "المطلوب: معرفة <b>ثالث أقل درجة</b> في الفصل.",
                steps: [
                    { t: "المفهوم", code: "=SMALL(", d: "عكس LARGE، تجلب أصغر القيم بالترتيب.", h: [] },
                    { t: "النطاق", code: "=SMALL(D2:D9,", d: "نحدد النطاق.", h: [3] },
                    { t: "الرتبة K", code: "=SMALL(D2:D9, 3)", d: "نريد <span class='highlight-text'>ثالث</span> أصغر درجة في الصف.", h: [3] },
                    { t: "النتيجة", code: "88", d: "ثالث أسوأ درجة هي 88.", h: [] }
                ]
            },
            { 
                name: "MAXIFS", 
                goal: "المطلوب: معرفة أعلى درجة، ولكن بشرط أن يكون الطالب من <b>الشعبة (أ)</b>.",
                steps: [
                    { t: "المفهوم", code: "=MAXIFS(", d: "أكبر قيمة <span class='highlight-text'>بشرط</span> محدد.", h: [] },
                    { t: "نطاق الماكس", code: "=MAXIFS(D2:D9,", d: "أولاً: حدد العمود الذي تريد الرقم منه (الدرجات).", h: [3] },
                    { t: "نطاق الشرط", code: "=MAXIFS(D2:D9, C2:C9,", d: "ثانياً: حدد عمود الشرط (الشعبة).", h: [2] }, 
                    { t: "الشرط", code: "=MAXIFS(D2:D9, C2:C9, \"أ\")", d: "ثالثاً: نكتب الشرط (الشعبة أ فقط).", h: [2] },
                    { t: "النتيجة", code: "98", d: "أعلى درجة في شعبة (أ) هي 98.", h: [] }
                ]
            },
            { 
                name: "MINIFS", 
                goal: "المطلوب: معرفة أقل درجة، ولكن بشرط أن يكون الطالب من <b>الشعبة (ب)</b>.",
                steps: [
                    { t: "المفهوم", code: "=MINIFS(", d: "أقل قيمة <span class='highlight-text'>بشرط</span>.", h: [] },
                    { t: "نطاق المين", code: "=MINIFS(D2:D9,", d: "حدد عمود الأرقام (الدرجات).", h: [3] },
                    { t: "نطاق الشرط", code: "=MINIFS(D2:D9, C2:C9,", d: "حدد عمود الشرط (الشعبة).", h: [2] },
                    { t: "الشرط", code: "=MINIFS(D2:D9, C2:C9, \"ب\")", d: "نريد أقل درجة في الشعبة (ب) فقط.", h: [2] },
                      { t: "النتيجة", code: "=65", d: "أقل درجة في شعبة ب هي 65.", h: [] }
                ]
            }
        ];

        // --- Mascot Images ---
        const mascotImages = [
            "https://raw.githubusercontent.com/BaselGhanem/LearningPath-SumGroup/refs/heads/main/1.png",
            "https://raw.githubusercontent.com/BaselGhanem/LearningPath-SumGroup/refs/heads/main/2.png",
            "https://raw.githubusercontent.com/BaselGhanem/LearningPath-SumGroup/refs/heads/main/3.png",
            "https://raw.githubusercontent.com/BaselGhanem/LearningPath-SumGroup/refs/heads/main/4.png",
            "https://raw.githubusercontent.com/BaselGhanem/LearningPath-SumGroup/refs/heads/main/5.png",
            "https://raw.githubusercontent.com/BaselGhanem/LearningPath-SumGroup/refs/heads/main/6.png",
            "https://raw.githubusercontent.com/BaselGhanem/LearningPath-SumGroup/refs/heads/main/7.png",
            "https://raw.githubusercontent.com/BaselGhanem/LearningPath-SumGroup/refs/heads/main/8.png"
        ];

        let currentLesson = 0;
        let currentStep = 0;

        // --- تهيئة ---
        window.onload = () => {
            renderSidebar();
            generateTable();
            updateUI(true);
        };

        // --- Typewriter Effect ---
        function typeWriter(text, elementId, speed = 40) {
            const element = document.getElementById(elementId);
            element.innerHTML = "";
            let i = 0;
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        // --- UI Update Logic ---
        function updateUI(animateType = false) {
            const lesson = lessons[currentLesson];
            const step = lesson.steps[currentStep];
            
            // تحديث الشخصية (Mascot) بناءً على الخطوة
            // نستخدم Modulo للتنقل عبر الصور بشكل دوري وممتع
            // (currentLesson + currentStep) يضمن تغيير الصورة مع كل نقرة
            const imgIndex = (currentLesson + currentStep) % mascotImages.length;
            const mascotImg = document.getElementById('mascotChar');
            
            // إضافة تأثير بسيط عند تغيير الصورة
            mascotImg.style.transform = "scale(0.8) rotate(5deg)";
            setTimeout(() => {
                mascotImg.src = mascotImages[imgIndex];
                mascotImg.style.transform = "scale(1) rotate(0deg)";
            }, 150);

            // تحديث السؤال الثابت
            document.getElementById('goalText').innerHTML = lesson.goal;

            // Sidebar
            document.querySelectorAll('.lesson-btn').forEach((b, i) => {
                b.className = `lesson-btn ${i === currentLesson ? 'active' : ''}`;
                if(i === currentLesson) {
                    b.innerHTML = `<span>${lessons[i].name}</span> <i class="fas fa-pen-fancy"></i>`;
                } else {
                    b.innerHTML = `<span>${lessons[i].name}</span>`;
                }
                
                // Auto scroll sidebar on mobile
                if(i === currentLesson && window.innerWidth <= 1024) {
                   b.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }
            });

            // Progress
            const progress = ((currentStep + 1) / lesson.steps.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;

            // Text
            document.getElementById('stepLabel').innerText = `${lesson.name} | خطوة ${currentStep + 1}`;
            document.getElementById('explanationText').innerHTML = step.d;

            // Code
            if (animateType) {
                typeWriter(step.code, 'visualCode');
            } else {
                document.getElementById('visualCode').innerText = step.code;
            }

            // Table Highlight
            highlightTable(step.h);

            // Buttons
            const nextBtn = document.getElementById('nextBtn');
            const backBtn = document.getElementById('backBtn');
            
            backBtn.disabled = (currentStep === 0 && currentLesson === 0);
            backBtn.style.opacity = backBtn.disabled ? 0.5 : 1;

            if (currentStep === lesson.steps.length - 1) {
                if(currentLesson < lessons.length - 1) {
                      nextBtn.innerHTML = `التالي: ${lessons[currentLesson+1].name} <i class="fas fa-forward"></i>`;
                      nextBtn.style.background = "#f39c12"; 
                } else {
                      nextBtn.innerHTML = `إنهاء الكورس <i class="fas fa-trophy"></i>`;
                      nextBtn.style.background = "#27ae60"; 
                }
            } else {
                nextBtn.innerHTML = `التالي <i class="fas fa-arrow-left"></i>`;
                nextBtn.style.background = ""; 
            }
        }

        // --- Table Highlight System ---
        function highlightTable(targetCols) {
            const rows = document.querySelectorAll('#dataTable tbody tr');
            const headers = document.querySelectorAll('#dataTable th');
            
            // Reset All
            rows.forEach(r => {
                Array.from(r.children).forEach(td => {
                    td.className = td.dataset.originalClass || ''; 
                    td.style.opacity = '0.4'; 
                });
            });
            headers.forEach(h => h.style.background = '#f8f9fa');

            // Apply Highlight
            if (targetCols && targetCols.length > 0) {
                targetCols.forEach(colIndex => {
                    headers[colIndex].style.background = '#d1f2eb';
                    rows.forEach(r => {
                        const cell = r.children[colIndex];
                        cell.style.opacity = '1';
                        
                        if(colIndex === 2) { 
                            cell.classList.add('highlight-criteria');
                        } else {
                            cell.classList.add('highlight-col');
                        }
                    });
                });
            } else {
                rows.forEach(r => {
                    Array.from(r.children).forEach(td => td.style.opacity = '1');
                });
            }
        }

        // --- Navigation ---
        function goNext() {
            const lesson = lessons[currentLesson];
            if (currentStep < lesson.steps.length - 1) {
                currentStep++;
                updateUI(true);
            } else if (currentLesson < lessons.length - 1) {
                currentLesson++;
                currentStep = 0;
                updateUI(true);
            } else {
                alert("أحسنت! لقد أتممت جميع المعادلات البسيطة بنجاح.");
            }
        }

        function goBack() {
            if (currentStep > 0) {
                currentStep--;
                updateUI(false);
            } else if (currentLesson > 0) {
                currentLesson--;
                currentStep = lessons[currentLesson].steps.length - 1;
                updateUI(false);
            }
        }

        function selectLesson(index) {
            currentLesson = index;
            currentStep = 0;
            updateUI(true);
        }

        function renderSidebar() {
            const nav = document.getElementById('sidePanel');
            nav.innerHTML = '';
            lessons.forEach((l, i) => {
                const btn = document.createElement('button');
                btn.className = 'lesson-btn';
                btn.onclick = () => selectLesson(i);
                btn.innerHTML = `<span>${l.name}</span>`;
                nav.appendChild(btn);
            });
        }

        // --- Data Generation ---
        function generateTable() {
            const tbody = document.getElementById('tableBody');
            const data = [
                { id: 1, name: "أحمد علي", class: "أ", score: 85 },
                { id: 2, name: "سارة خالد", class: "أ", score: 98 },
                { id: 3, name: "عمر يوسف", class: "ب", score: null }, 
                { id: 4, name: "ليلى حسن", class: "ب", score: 95 },
                { id: 5, name: "خالد سامي", class: "أ", score: "غائب" }, 
                { id: 6, name: "نور الهدى", class: "ب", score: 65 },
                { id: 7, name: "رامي كمال", class: "أ", score: 88 },
                { id: 8, name: "هدى بيطار", class: "ب", score: 92 }
            ];
            
            let html = '';
            data.forEach(row => {
                let scoreClass = '';
                let scoreDisplay = row.score;

                if (row.score === null) {
                    scoreDisplay = ""; 
                    scoreClass = 'empty-cell';
                } else if (typeof row.score === 'string') {
                    scoreClass = 'text-cell';
                }

                html += `<tr>
                    <td>${row.id}</td>
                    <td>${row.name}</td>
                    <td data-original-class="">${row.class}</td>
                    <td data-original-class="${scoreClass}" class="${scoreClass}">${scoreDisplay}</td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }
    </script>
</body>
</html>
